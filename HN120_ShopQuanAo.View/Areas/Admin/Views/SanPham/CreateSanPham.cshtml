@using HN120_ShopQuanAo.Data.ViewModels
@using HN120_ShopQuanAo.Data.Models
@model AddSpViewModel

@{
    ViewData["Title"] = "Create and Add Details for Product";
    Layout = "~/Areas/Admin/Views/Shared/_LayoutAdmin.cshtml";
    var lstSZ = ViewBag.lstSZ as List<Size> ?? new List<Size>();
    var lstms = ViewBag.lstms as List<MauSac> ?? new List<MauSac>();
    var lstTH = ViewBag.lstTH as List<ThuongHieu>;
    var lstTL = ViewBag.lstTL as List<TheLoai>;
    var lstCL = ViewBag.lstCL as List<ChatLieu>;
}

<h1>Create and Add Details for Product</h1>

<form id="createProductForm" method="post" enctype="multipart/form-data">
    <div class="form-group">
        <label>Thương Hiệu:</label>
        <select class="form-select" id="MaThuongHieu" name="MaThuongHieu">
            <option value=""></option>
            @foreach (var item in lstTH)
            {
                        <option value="@item.MaThuongHieu">@item.TenThuongHieu</option>
            }
        </select>
    </div>
    <div class="form-group">
        <label>Thể Loại:</label>
        <select class="form-select" id="MaTheLoai" name="MaTheLoai">
            <option value=""></option>
            @foreach (var item in lstTL)
            {
                        <option value="@item.MaTheLoai">@item.TenTheLoai</option>
            }
        </select>
    </div>
    <div class="form-group">
        <label>Chất Liệu:</label>
        <select class="form-select" id="MaChatLieu" name="MaChatLieu">
            <option value=""></option>
            @foreach (var item in lstCL)
            {
                        <option value="@item.MaChatLieu">@item.TenChatLieu</option>
            }
        </select>
    </div>
    <div class="form-group">
        <label>Ảnh Đại Diện:</label>
        <input type="file" class="form-control" id="imageSP" name="imageSP" />
    </div>
    <div class="form-group">
        <label>Tên Sản Phẩm:</label>
        <input class="form-control" id="TenSP" name="TenSP" />
    </div>
    <div class="form-group">
        <label>Mô Tả:</label>
        <input class="form-control" id="Mota" name="Mota" />
    </div>

    <h2>Chi Tiết Sản Phẩm</h2>

    <div class="form-group">
        <label>Size:</label>
        <div class="form-check-container" id="sizeContainer">
            @foreach (var size in lstSZ)
            {
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" name="selectedSizes" value="@size.MaSize" />
                            <label class="form-check-label">@size.TenSize</label>
                        </div>
            }
        </div>
    </div>
    <div class="form-group">
        <label>Màu:</label>
        <div class="form-check-container" id="colorContainer">
            @foreach (var mau in lstms)
            {
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" name="selectedColors" value="@mau.MaMau" />
                            <label class="form-check-label">@mau.TenMau</label>
                        </div>
            }
        </div>
    </div>

    <button type="button" class="btn btn-primary" onclick="addChiTietSp()">Thêm chi tiết sản phẩm</button>

    <div id="chiTietSpContainer" class="table-responsive" style="display:none;">
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>Size</th>
                    <th>Màu</th>
                    <th>Đơn giá</th>
                    <th>Số lượng tồn</th>
                    <th>URL Ảnh</th>
                    <th>Hành động</th>
                </tr>
            </thead>
            <tbody>
                <!-- Các chi tiết sản phẩm sẽ được thêm vào đây -->
            </tbody>
        </table>
    </div>

    <button type="submit" class="btn btn-success">Lưu</button>
</form>

@section Scripts {
            <script>
                function addChiTietSp() {
                    var sizeCheckboxes = document.querySelectorAll("input[name='selectedSizes']:checked");
                    var colorCheckboxes = document.querySelectorAll("input[name='selectedColors']:checked");
                    var container = document.querySelector("#chiTietSpContainer tbody");
                    var count = container.children.length;

                    if (sizeCheckboxes.length > 0 && colorCheckboxes.length > 0) {
                        document.getElementById("chiTietSpContainer").style.display = "block";
                    }

                    sizeCheckboxes.forEach(sizeCheckbox => {
                        var size = sizeCheckbox.value;
                        var sizeText = sizeCheckbox.nextElementSibling.innerText;

                        colorCheckboxes.forEach(colorCheckbox => {
                            var color = colorCheckbox.value;
                            var colorText = colorCheckbox.nextElementSibling.innerText;

                            var existingRow = Array.from(container.children).find(row => {
                                var existingSize = row.querySelector(`input[name*='MaSize'][value='${size}']`);
                                var existingColor = row.querySelector(`input[name*='MaMau'][value='${color}']`);
                                return existingSize && existingColor;
                            });

                            if (existingRow) {
                                alert("Thuộc tính này đã có trong danh sách cần thêm");
                                return;
                            }

                            var newChiTietSpRow = document.createElement("tr");
                            newChiTietSpRow.innerHTML = `
                                <td>
                                    <input type="hidden" name="ChiTietSps[${count}].MaSize" value="${size}" />
                                    ${sizeText}
                                </td>
                                <td>
                                    <input type="hidden" name="ChiTietSps[${count}].MaMau" value="${color}" />
                                    ${colorText}
                                </td>
                                <td>
                                    <input type="number" class="form-control" name="ChiTietSps[${count}].DonGia" required />
                                </td>
                                <td>
                                    <input type="number" class="form-control" name="ChiTietSps[${count}].SoLuongTon" required />
                                </td>
                                <td>
                                        <input type="file" class="form-control" name="imagechitietsp" />
                                </td>
                                <td>
                                    <button type="button" class="btn btn-danger" onclick="removeRow(this)">Xóa</button>
                                </td>
                            `;
                            container.appendChild(newChiTietSpRow);
                            count++;
                        });
                    });
                }

                function removeRow(button) {
                    var row = button.closest("tr");
                    row.parentNode.removeChild(row);
                }
            </script>
}
